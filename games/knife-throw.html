<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knife Throw</title>
    <style>
        body { margin: 0; overflow: hidden; background: #2c3e50; font-family: 'Segoe UI', sans-serif; touch-action: none; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        canvas { box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-radius: 5px; cursor: pointer; }
        #score { position: absolute; top: 10%; font-size: 3rem; color: rgba(255,255,255,0.8); font-weight: bold; pointer-events: none; }
        #knivesLeft { position: absolute; bottom: 10%; display: flex; gap: 5px; opacity: 0.8; pointer-events: none; }
        .knife-icon { width: 10px; height: 30px; background: #bdc3c7; clip-path: polygon(0 0, 100% 0, 50% 100%); }
        .knife-icon.used { background: #555; }
        #msg { position: absolute; background: rgba(0,0,0,0.9); padding: 40px; text-align: center; color: white; display: none; border-radius: 10px; }
        button { padding: 10px 20px; font-size: 1.2rem; margin-top: 10px; background: #e67e22; border: none; color: white; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="score">0</div>
    <canvas id="gameCanvas"></canvas>
    <div id="knivesLeft"></div>

    <div id="msg">
        <h2 id="msgText">Stage Cleared!</h2>
        <button onclick="nextStage()" id="nextBtn">Next Stage</button>
        <button onclick="restartGame()" id="restartBtn" style="display:none">Try Again</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const knivesDiv = document.getElementById('knivesLeft');
        let width, height;

        // Game State
        let stage = 1;
        let score = 0;
        let target = { angle: 0, speed: 0.02, radius: 80, objects: [] }; // objects: {angle, type: 'knife'|'apple'}
        let currentKnife = null; // { y: ... }
        let knivesToThrow = 7;
        let knivesThrown = 0;
        let gameActive = true;

        function resize() {
            width = Math.min(window.innerWidth, 500);
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            target.y = height * 0.3;
        }
        window.addEventListener('resize', resize);
        resize();

        function initStage() {
            target.objects = [];
            target.angle = 0;
            knivesThrown = 0;

            // Difficutly
            target.speed = 0.02 + (stage * 0.005);
            knivesToThrow = 5 + Math.min(5, Math.floor(stage / 2));

            // Add existing obstacles (simulated from prev levels or just random)
            let obstacles = Math.floor(Math.random() * 3);
            for(let i=0; i<obstacles; i++) {
                target.objects.push({
                    angle: Math.random() * Math.PI * 2,
                    type: 'knife'
                });
            }

            // Add apples
            if (Math.random() > 0.5) {
                target.objects.push({
                    angle: Math.random() * Math.PI * 2,
                    type: 'apple'
                });
            }

            updateKnivesUI();
            spawnKnife();
            gameActive = true;
            document.getElementById('msg').style.display = 'none';
            loop();
        }

        function spawnKnife() {
            currentKnife = { y: height - 100, state: 'ready' };
        }

        function updateKnivesUI() {
            knivesDiv.innerHTML = '';
            for(let i=0; i<knivesToThrow; i++) {
                const k = document.createElement('div');
                k.className = 'knife-icon' + (i < (knivesToThrow - (knivesToThrow - knivesThrown)) ? ' used' : '');
                // Actually we show remaining
                if (i >= knivesToThrow - knivesThrown) {
                     k.className = 'knife-icon'; // Active
                } else {
                     k.className = 'knife-icon used'; // Used
                }
                // Wait, easier: show dots for available knives
                // Left to right
            }

            // Better: just dots for remaining
            knivesDiv.innerHTML = '';
            for(let i=0; i<knivesToThrow - knivesThrown; i++) {
                 const k = document.createElement('div');
                 k.className = 'knife-icon';
                 knivesDiv.appendChild(k);
            }
        }

        function throwKnife() {
            if (!gameActive || currentKnife.state !== 'ready') return;
            currentKnife.state = 'flying';
            knivesThrown++;
            updateKnivesUI();
        }

        function update() {
            if (!gameActive) return;

            // Rotate Target
            target.angle += target.speed;

            // Vary speed for difficulty
            if (stage > 3 && Math.random() < 0.02) target.speed *= -1; // Random reverse
            if (stage > 5 && Math.random() < 0.05) target.speed = (Math.random() - 0.5) * 0.1; // Random speed change

            // Move Knife
            if (currentKnife.state === 'flying') {
                currentKnife.y -= 40;

                // Collision with Target
                if (currentKnife.y <= target.y + target.radius) {
                    // Check Hit
                    const hitAngle = Math.PI / 2 - target.angle; // Bottom is PI/2
                    const normalizedHit = normalizeAngle(hitAngle);

                    let collision = false;

                    for(let obj of target.objects) {
                        if (obj.type === 'knife') {
                            // Check angular distance
                            const diff = Math.abs(normalizeAngle(obj.angle) - normalizedHit);
                            // Angle minimal distance on circle
                            const dist = Math.min(diff, Math.PI*2 - diff);

                            if (dist < 0.2) { // Too close (approx 12 degrees)
                                collision = true;
                                break;
                            }
                        } else if (obj.type === 'apple') {
                            // Hit apple
                             const diff = Math.abs(normalizeAngle(obj.angle) - normalizedHit);
                             const dist = Math.min(diff, Math.PI*2 - diff);
                             if (dist < 0.25) {
                                 // Sliced apple!
                                 score += 5;
                                 obj.dead = true;
                                 // Remove apple
                             }
                        }
                    }

                    // Filter dead objects
                    target.objects = target.objects.filter(o => !o.dead);

                    if (collision) {
                        gameOver();
                    } else {
                        // Success Hit
                        target.objects.push({
                            angle: normalizedHit,
                            type: 'knife'
                        });
                        score++;
                        document.getElementById('score').innerText = score;

                        // Shake effect
                        target.y += 5;
                        setTimeout(() => target.y -= 5, 50);

                        if (knivesThrown >= knivesToThrow) {
                            levelClear();
                        } else {
                            spawnKnife();
                        }
                    }
                }
            }
        }

        function normalizeAngle(a) {
            a = a % (Math.PI * 2);
            if (a < 0) a += Math.PI * 2;
            return a;
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // Draw Target (Log)
            ctx.save();
            ctx.translate(width/2, target.y);
            ctx.rotate(target.angle);

            ctx.fillStyle = "#8e44ad";
            ctx.beginPath();
            ctx.arc(0, 0, target.radius, 0, Math.PI*2);
            ctx.fill();

            // Draw Objects attached
            target.objects.forEach(obj => {
                ctx.save();
                ctx.rotate(obj.angle);
                if (obj.type === 'knife') {
                    ctx.fillStyle = "#bdc3c7";
                    ctx.fillRect(-5, target.radius - 10, 10, 60);
                    ctx.fillStyle = "#7f8c8d";
                    ctx.fillRect(-5, target.radius + 50, 10, 20); // Handle
                } else if (obj.type === 'apple') {
                    ctx.fillStyle = "#e74c3c";
                    ctx.beginPath();
                    ctx.arc(0, target.radius, 15, 0, Math.PI*2);
                    ctx.fill();
                    ctx.fillStyle = "#27ae60"; // Leaf
                    ctx.fillRect(-2, target.radius - 15, 4, 10);
                }
                ctx.restore();
            });

            ctx.restore();

            // Draw Current Knife
            if (currentKnife) {
                ctx.fillStyle = "#bdc3c7";
                ctx.fillRect(width/2 - 5, currentKnife.y, 10, 60);
                ctx.fillStyle = "#7f8c8d"; // Handle
                ctx.fillRect(width/2 - 5, currentKnife.y + 60, 10, 30);
            }
        }

        function levelClear() {
            gameActive = false;
            document.getElementById('msgText').innerText = "Stage " + stage + " Cleared!";
            document.getElementById('nextBtn').style.display = 'inline-block';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('msg').style.display = 'block';
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('msgText').innerText = "Game Over!";
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'inline-block';
            document.getElementById('msg').style.display = 'block';
        }

        function nextStage() {
            stage++;
            initStage();
        }

        function restartGame() {
            stage = 1;
            score = 0;
            document.getElementById('score').innerText = score;
            initStage();
        }

        function loop() {
            if (gameActive) {
                update();
                draw();
                requestAnimationFrame(loop);
            }
        }

        // Input
        document.addEventListener('mousedown', throwKnife);
        document.addEventListener('touchstart', (e) => { e.preventDefault(); throwKnife(); }, {passive: false});
        document.addEventListener('keydown', (e) => { if(e.code === 'Space') throwKnife(); });

        initStage();

    </script>
</body>
</html>
